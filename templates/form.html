{% extends "base.html" %}

{% block head %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Model Paper Generator</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
{% endblock %}

{% block content %}
<main class="container" role="main" aria-labelledby="pageTitle">
  <div class="header-section">
    <h1 id="pageTitle" tabindex="0">
      <span class="emoji">üß†</span> Model Paper Generator
    </h1>
    <p class="tagline">
      Crafting custom model papers has never been this easy. Let's get started!
    </p>
  </div>

  <form id="paperForm" aria-describedby="formInstructions" novalidate>
    <p id="formInstructions" class="sr-only">Fill in the form below to generate your model paper PDF.</p>

    <div class="form-grid">
      <div class="card subject-card">
        <fieldset>
          <legend><span class="emoji">üìö</span> Choose Your Subject</legend>
          <label for="subject" class="sr-only">Subject</label>
          <select name="subject" id="subject" required aria-required="true" aria-describedby="subjectHint">
            <option value="" disabled selected>Pick a subject</option>
            <option value="Maths">Mathematics</option>
            <option value="Science">Science</option>
            <option value="Social">Social Studies</option>
            <option value="English">English</option>
          </select>
          <small id="subjectHint" class="hint-text">Start by picking a subject from the list.</small>
        </fieldset>
      </div>

      <div class="card chapter-card">
        <fieldset>
          <legend><span class="emoji">üìñ</span> Select a Chapter</legend>
          <label for="chapter" class="sr-only">Chapter</label>
          <select name="chapter" id="chapter" required aria-required="true" aria-describedby="chapterHint" disabled>
            <option value="" disabled selected>Choose a chapter...</option>
          </select>
          <small id="chapterHint" class="hint-text">This dropdown will fill with chapters for your chosen subject.</small>
        </fieldset>
      </div>
      
      <div class="card difficulty-card">
        <fieldset>
          <legend><span class="emoji">üéØ</span> Difficulty Level</legend>
          <div class="difficulty-options" role="radiogroup" aria-labelledby="difficulty-legend">
            <input type="radio" id="easy" name="difficulty" value="easy">
            <label for="easy" class="radio-label">Easy Mode</label>

            <input type="radio" id="moderate" name="difficulty" value="moderate" checked>
            <label for="moderate" class="radio-label">Standard</label>

            <input type="radio" id="difficult" name="difficulty" value="difficult">
            <label for="difficult" class="radio-label">Hardcore</label>
          </div>
          <small id="difficultyHint" class="hint-text">Choose how challenging you want the paper to be!</small>
        </fieldset>
      </div>

      <div class="card suggestions-card">
        <label for="suggestions"><span class="emoji">üìù</span> Any extra requests? <small>(Optional)</small></label>
        <textarea name="suggestions" id="suggestions" rows="4" placeholder="E.g., 'Please focus on algebraic problems'"></textarea>
      </div>
    </div>

    <div class="button-container">
      <button type="submit" id="generateBtn" aria-live="polite" aria-busy="false">
        Generate & Download Paper <span class="emoji">üöÄ</span>
      </button>
    </div>
  </form>

  <div class="contact-info">
    <p>Having trouble? Feel free to <a href="mailto:laxmanchowdary159@gmail.com">drop us a line</a>!</p>
    <p>Proudly made by <a href="mailto:laxmanchowdary159@gmail.com">Laxman Nimmagadda</a></p>
  </div>

  <div id="loadingModal" class="modal" role="alertdialog" aria-modal="true" aria-hidden="true" aria-live="assertive">
    <div class="modal-content">Hold on, we're generating your paper!</div>
  </div>

  <div id="errorMessage" class="error-message" role="alert" aria-live="assertive" style="display:none;">
    Uh-oh! Something went wrong. Let's give it another shot.
  </div>
</main>

<script>
  const chaptersBySubject = {
    "Maths": [
      "Real Numbers", "Polynomials", "Pair of Linear Equations in Two Variables",
      "Quadratic Equations", "Arithmetic Progressions", "Triangles",
      "Coordinate Geometry", "Introduction to Trigonometry", "Some Applications of Trigonometry",
      "Circles", "Constructions", "Areas Related to Circles", "Surface Areas and Volumes",
      "Statistics", "Probability"
    ],
    "Science": [
      "Chemical Reactions and Equations", "Acids, Bases, and Salts", "Metals and Non-Metals",
      "Carbon and Its Compounds", "Periodic Classification of Elements", "Life Processes",
      "Control and Coordination", "How do Organisms Reproduce?", "Heredity and Evolution",
      "Light ‚Äì Reflection and Refraction", "The Human Eye and the Colourful World", "Electricity",
      "Magnetic Effects of Electric Current", "Sources of Energy"
    ],
    "Social": [
      "Nationalism in India", "The Making of a Global World", "The Age of Industrialization",
      "Print Culture and the Modern World", "Resources and Development", "Forest and Wildlife Resources",
      "Water Resources", "Agriculture", "Minerals and Energy Resources", "Manufacturing Industries",
      "Lifelines of National Economy", "Power Sharing", "Federalism", "Democracy and Diversity",
      "Gender, Religion and Caste", "Popular Struggles and Movements", "Political Parties",
      "Outcomes of Democracy", "Challenges to Democracy"
    ],
    "English": [
      "A Letter to God", "Nelson Mandela: Long Walk to Freedom", "Two Stories about Flying",
      "From the Diary of Anne Frank", "Glimpses of India", "Mijbil the Otter",
      "Madam Rides the Bus", "The Hundred Dresses", "The Hundred Dresses ‚Äì II",
      "A Baker from Goa", "Amanda", "Animals", "The Trees", "Fog", "The Tale of Custard the Dragon",
      "The Ball Poem", "The Invisible Man", "The Treasure within", "Footprints without Feet",
      "The Magic Drum and Other Favourite Stories", "The Necklace", "The Hack Driver",
      "Bholi", "The Book that Saved the Earth"
    ]
  };

  const subjectSelect = document.getElementById('subject');
  const chapterSelect = document.getElementById('chapter');
  const form = document.getElementById('paperForm');
  const button = document.getElementById('generateBtn');
  const modal = document.getElementById('loadingModal');
  const errorBox = document.getElementById('errorMessage');

  subjectSelect.addEventListener('change', () => {
    const subject = subjectSelect.value;
    chapterSelect.innerHTML = '<option value="" disabled selected>Choose a chapter...</option>';
    if (chaptersBySubject[subject]) {
      chaptersBySubject[subject].forEach(chapter => {
        const option = document.createElement('option');
        option.value = chapter;
        option.textContent = chapter;
        chapterSelect.appendChild(option);
      });
      chapterSelect.disabled = false;
    } else {
      chapterSelect.disabled = true;
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorBox.style.display = 'none';
    modal.setAttribute('aria-hidden', 'false');
    modal.style.display = 'flex';
    button.disabled = true;
    button.setAttribute('aria-busy', 'true');

    const formData = new FormData(form);
    try {
      const response = await fetch("/", { method: "POST", body: formData });
      if (!response.ok || !response.headers.get('Content-Type').includes('application/pdf')) {
        throw new Error("Invalid response");
      }
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      const filename = response.headers.get('Content-Disposition')?.split('filename=')[1] || 'model_paper.pdf';
      a.href = url;
      a.download = filename.replace(/["']/g, '');
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (err) {
      errorBox.style.display = 'block';
    } finally {
      modal.setAttribute('aria-hidden', 'true');
      modal.style.display = 'none';
      button.disabled = false;
      button.setAttribute('aria-busy', 'false');
    }
  });
</script>
{% endblock %}
