{% extends "base.html" %}

{% block content %}
<main class="container" role="main" aria-labelledby="pageTitle">
  <h1 id="pageTitle" tabindex="0">🎉 Model Paper Generator 🎉 <small>(Class 10 Only 🚀)</small></h1>

  <form id="paperForm" method="post" aria-describedby="formInstructions" novalidate>
    <p id="formInstructions" class="sr-only">Fill in the form below to generate your model paper PDF.</p>

    <!-- Subject Selection -->
    <fieldset>
      <legend>📚 Choose Your Subject</legend>
      <label for="subject" class="sr-only">Subject</label>
      <select name="subject" id="subject" required aria-required="true" aria-describedby="subjectHint">
        <option value="" disabled selected>Pick a subject</option>
        {% for subject in subjects %}
          <option value="{{ subject }}">{{ subject }}</option>
        {% endfor %}
      </select>
      <small id="subjectHint" class="hint-text">Select one subject to proceed</small>
    </fieldset>

    <!-- Chapter Selection -->
    <fieldset>
      <legend>📖 Select a Chapter</legend>
      <label for="chapter" class="sr-only">Chapter</label>
      <select name="chapter" id="chapter" required aria-required="true" aria-describedby="chapterHint" disabled>
        <option value="" disabled selected>Choose a chapter...</option>
      </select>
      <small id="chapterHint" class="hint-text">Choose a chapter based on selected subject</small>
    </fieldset>

    <!-- Difficulty Selection -->
    <fieldset>
      <legend>🎯 Difficulty Level</legend>
      <label for="difficulty" class="sr-only">Difficulty</label>
      <select name="difficulty" id="difficulty" required aria-required="true" aria-describedby="difficultyHint">
        <option value="easy">Easy Peasy 🍋</option>
        <option value="moderate" selected>Moderate 🎯</option>
        <option value="difficult">Challenge Mode 💥</option>
      </select>
      <small id="difficultyHint" class="hint-text">Select difficulty of the paper</small>
    </fieldset>

    <!-- Suggestions -->
    <fieldset class="floating-label">
      <textarea name="suggestions" id="suggestions" rows="4" placeholder=" "></textarea>
      <label for="suggestions">📝 Any extra requirements? (Optional)</label>
    </fieldset>

    <!-- Submit Button -->
    <button type="submit" id="generateBtn" aria-live="polite" aria-busy="false">
      Generate PDF &amp; Download 🚀
    </button>
  </form>

  <p class="contact-info" aria-label="Contact information">
    🛠️ Issues? Contact <strong>Laxman Nimmagadda</strong> at
    <a href="mailto:laxmanchowdary159@gmail.com">laxmanchowdary159@gmail.com</a>
  </p>

  <!-- Modal -->
  <div id="loadingModal" class="modal" role="alertdialog" aria-modal="true" aria-hidden="true" aria-live="assertive">
    <div class="modal-content">⏳ Generating your PDF, please wait...</div>
  </div>

  <!-- Error Message -->
  <div id="errorMessage" class="error-message" role="alert" aria-live="assertive" style="display:none;">
    ❌ Something went wrong. Please try again.
  </div>
</main>

<script>
  const chaptersBySubject = {{ chapters_by_subject | tojson }};

  const subjectSelect = document.getElementById('subject');
  const chapterSelect = document.getElementById('chapter');

  subjectSelect.addEventListener('change', () => {
    const subject = subjectSelect.value;
    chapterSelect.innerHTML = '<option value="" disabled selected>Choose a chapter...</option>';
    if (chaptersBySubject[subject]) {
      chaptersBySubject[subject].forEach(chapter => {
        const option = document.createElement('option');
        option.value = chapter;
        option.textContent = chapter;
        chapterSelect.appendChild(option);
      });
      chapterSelect.disabled = false;
    } else {
      chapterSelect.disabled = true;
    }
  });

  const form = document.getElementById('paperForm');
  const button = document.getElementById('generateBtn');
  const modal = document.getElementById('loadingModal');
  const errorBox = document.getElementById('errorMessage');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorBox.style.display = 'none';
    modal.setAttribute('aria-hidden', 'false');
    modal.style.display = 'flex';
    button.disabled = true;
    button.setAttribute('aria-busy', 'true');

    const formData = new FormData(form);
    try {
      const response = await fetch("/", { method: "POST", body: formData });
      if (!response.ok || !response.headers.get('Content-Type').includes('application/pdf')) {
        throw new Error("Invalid response");
      }
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      const filename = response.headers.get('Content-Disposition')?.split('filename=')[1] || 'model_paper.pdf';
      a.href = url;
      a.download = filename.replace(/["']/g, '');
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    } catch (err) {
      errorBox.style.display = 'block';
    } finally {
      modal.setAttribute('aria-hidden', 'true');
      modal.style.display = 'none';
      button.disabled = false;
      button.setAttribute('aria-busy', 'false');
    }
  });
</script>
{% endblock %}
